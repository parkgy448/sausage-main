<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>관리자 - SSS CASINO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617; color:#f9fafb;
      min-height:100vh; padding:16px;
    }
    h1 { font-size:20px; margin-bottom:8px; }
    h2 { font-size:16px; margin-top:18px; margin-bottom:4px; }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th,td { border-bottom:1px solid rgba(148,163,184,.3); padding:6px 4px; text-align:left; }
    button {
      font-size:11px; border-radius:999px; border:none; padding:4px 8px;
      cursor:pointer;
    }
    .btn-approve { background:#22c55e; color:#022c22; }
    .btn-reject { background:#ef4444; color:#fee2e2; }
    .tag { font-size:11px; padding:2px 6px; border-radius:999px; }
    .tag-pending { background:#facc15; color:#422006; }
    .tag-approved { background:#22c55e; color:#022c22; }
    .tag-rejected { background:#ef4444; color:#fee2e2; }
    a { color:#38bdf8; font-size:12px; }
  </style>
</head>
<body>
  <h1>관리자 페이지</h1>
  <div id="adminInfo" style="font-size:13px;margin-bottom:10px;">권한 확인 중...</div>
  <p style="font-size:12px;margin-bottom:10px;">
    <a href="index.html">⟵ 메인으로 돌아가기</a>
  </p>

  <h2>충전 신청 (대기)</h2>
  <table>
    <thead>
      <tr>
        <th>유저</th>
        <th>금액</th>
        <th>정보</th>
        <th>상태</th>
        <th>액션</th>
      </tr>
    </thead>
    <tbody id="depositBody">
      <tr><td colspan="5">불러오는 중...</td></tr>
    </tbody>
  </table>

  <h2>환전 신청 (대기)</h2>
  <table>
    <thead>
      <tr>
        <th>유저</th>
        <th>금액</th>
        <th>정보</th>
        <th>상태</th>
        <th>액션</th>
      </tr>
    </thead>
    <tbody id="withdrawBody">
      <tr><td colspan="5">불러오는 중...</td></tr>
    </tbody>
  </table>

  <script type="module">
    import { auth, db } from "./js/firebase-config.js";
    import {
      listenAuth,
      fetchCurrentUserProfile
    } from "./js/auth-utils.js";
    import {
      collection,
      query,
      where,
      onSnapshot,
      doc,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const adminInfo = document.getElementById("adminInfo");
    const depositBody = document.getElementById("depositBody");
    const withdrawBody = document.getElementById("withdrawBody");

    let isAdmin = false;

    listenAuth(async (user) => {
      if (!user) {
        alert("로그인이 필요합니다.");
        window.location.href = "index.html";
        return;
      }
      const profile = await fetchCurrentUserProfile(user.uid);
      if (profile?.role !== "admin") {
        adminInfo.textContent = "관리자 권한이 없습니다.";
        alert("관리자만 접근 가능합니다.");
        window.location.href = "index.html";
        return;
      }
      isAdmin = true;
      adminInfo.textContent = "관리자: " + (profile.nickname || user.email);

      const q1 = query(
        collection(db, "deposits"),
        where("status", "==", "pending")
      );
      onSnapshot(q1, (snap) => {
        if (snap.empty) {
          depositBody.innerHTML = '<tr><td colspan="5">대기 중인 신청이 없습니다.</td></tr>';
          return;
        }
        depositBody.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.senderName || "-"} <br/><small>${d.userId}</small></td>
            <td>${(d.amount || 0).toLocaleString()}원</td>
            <td>${d.bankName || ""}</td>
            <td><span class="tag tag-pending">대기</span></td>
            <td>
              <button class="btn-approve">승인</button>
              <button class="btn-reject">거절</button>
            </td>
          `;
          const approveBtn = tr.querySelector(".btn-approve");
          const rejectBtn = tr.querySelector(".btn-reject");
          approveBtn.addEventListener("click", () => handleDepositDecision(docSnap.id, d, true));
          rejectBtn.addEventListener("click", () => handleDepositDecision(docSnap.id, d, false));
          depositBody.appendChild(tr);
        });
      });

      const q2 = query(
        collection(db, "withdrawals"),
        where("status", "==", "pending")
      );
      onSnapshot(q2, (snap) => {
        if (snap.empty) {
          withdrawBody.innerHTML = '<tr><td colspan="5">대기 중인 신청이 없습니다.</td></tr>';
          return;
        }
        withdrawBody.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.accountName || "-"} <br/><small>${d.userId}</small></td>
            <td>${(d.amount || 0).toLocaleString()}원</td>
            <td>${d.bankName || ""}</td>
            <td><span class="tag tag-pending">대기</span></td>
            <td>
              <button class="btn-approve">승인</button>
              <button class="btn-reject">거절</button>
            </td>
          `;
          const approveBtn = tr.querySelector(".btn-approve");
          const rejectBtn = tr.querySelector(".btn-reject");
          approveBtn.addEventListener("click", () => handleWithdrawDecision(docSnap.id, d, true));
          rejectBtn.addEventListener("click", () => handleWithdrawDecision(docSnap.id, d, false));
          withdrawBody.appendChild(tr);
        });
      });
    });

    async function handleDepositDecision(docId, data, approve) {
      if (!isAdmin) return;
      if (!confirm(`충전신청을 ${approve ? "승인" : "거절"}하시겠습니까?`)) return;

      const depositRef = doc(db, "deposits", docId);
      const userRef = doc(db, "users", data.userId);

      try {
        await runTransaction(db, async (transaction) => {
          const depSnap = await transaction.get(depositRef);
          if (!depSnap.exists()) throw new Error("이미 삭제된 신청입니다.");
          const dep = depSnap.data();
          if (dep.status !== "pending") throw new Error("이미 처리된 신청입니다.");

          const userSnap = await transaction.get(userRef);
          if (!userSnap.exists()) throw new Error("유저 데이터가 없습니다.");
          const userData = userSnap.data();

          const newStatus = approve ? "approved" : "rejected";
          transaction.update(depositRef, { status: newStatus });

          if (approve) {
            const newMoney = (userData.money || 0) + (dep.amount || 0);
            transaction.update(userRef, { money: newMoney });
          }
        });
        alert("처리되었습니다.");
      } catch (err) {
        alert("오류: " + err.message);
      }
    }

    async function handleWithdrawDecision(docId, data, approve) {
      if (!isAdmin) return;
      if (!confirm(`환전신청을 ${approve ? "승인" : "거절"}하시겠습니까?`)) return;

      const withdrawRef = doc(db, "withdrawals", docId);
      const userRef = doc(db, "users", data.userId);

      try {
        await runTransaction(db, async (transaction) => {
          const wSnap = await transaction.get(withdrawRef);
          if (!wSnap.exists()) throw new Error("이미 삭제된 신청입니다.");
          const w = wSnap.data();
          if (w.status !== "pending") throw new Error("이미 처리된 신청입니다.");

          const userSnap = await transaction.get(userRef);
          if (!userSnap.exists()) throw new Error("유저 데이터가 없습니다.");
          const userData = userSnap.data();

          const newStatus = approve ? "approved" : "rejected";
          transaction.update(withdrawRef, { status: newStatus });

          if (approve) {
            const newMoney = (userData.money || 0) - (w.amount || 0);
            if (newMoney < 0) throw new Error("유저 잔액 부족");
            transaction.update(userRef, { money: newMoney });
          }
        });
        alert("처리되었습니다.");
      } catch (err) {
        alert("오류: " + err.message);
      }
    }
  </script>
</body>
</html>
