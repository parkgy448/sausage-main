<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 | BETCLOUD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Firebase and dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <script src="auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;800&display=swap');
        body {
            font-family: 'Oxanium', sans-serif;
            background-color: #0a0a12;
            color: white;
        }
        .admin-tab.active {
            background-color: #f97316;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #374151;
        }
        .admin-action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }
        .admin-action-btn.info {
            background-color: #3b82f6;
            color: white;
        }
        .admin-action-btn.approve {
            background-color: #10b981;
            color: white;
        }
        .admin-action-btn.reject {
            background-color: #ef4444;
            color: white;
        }
        .admin-action-btn.delete {
            background-color: #dc2626;
            color: white;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-active {
            background-color: #10b981;
            color: white;
        }
        .status-banned {
            background-color: #ef4444;
            color: white;
        }
        .status-pending {
            background-color: #f59e0b;
            color: white;
        }
    
        .admin-action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
            border: none;
            background-color: #374151; /* default visible background for action buttons */
            color: white;
            cursor: pointer;
        }
        .admin-action-btn:hover { filter: brightness(1.06); }
        .admin-action-btn.complete { background-color: #10b981; color: white; }
        .admin-action-btn.block-ip { background-color: #ef4444; color: white; }
        .admin-action-btn[data-action="reset-pw"] { background-color: #f59e0b; color: white; }

    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center fixed top-0 left-0 w-full z-50 bg-black/60 backdrop-blur-md py-3 px-4">
            <div id="adminName" class="text-white"></div>
            <a href="index.html" class="mx-auto">
                <img src="https://i.ibb.co/xdhYSGr/logo.png" alt="LEAVES Logo" class="h-12 md:h-16 object-contain">
            </a>
            <a href="index.html" class="text-gray-400 hover:text-white">
                <i data-feather="x"></i>
            </a>
        </header>

        <!-- 통계 카드 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 mt-16">
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-orange-400" id="totalUsers">0</div>
                <div class="text-sm text-gray-400">전체 회원</div>
            </div>
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-400" id="todayUsers">0</div>
                <div class="text-sm text-gray-400">오늘 가입</div>
            </div>
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-400" id="activeUsers">0</div>
                <div class="text-sm text-gray-400">활성 회원</div>
            </div>
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-400" id="bannedUsers">0</div>
                <div class="text-sm text-gray-400">정지 회원</div>
            </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="flex overflow-x-auto border-b border-gray-700 mb-6">
            <button class="admin-tab active px-6 py-3 font-bold whitespace-nowrap" data-tab="users">회원 관리</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="approvals">가입승인</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="charges">충전 관리</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="exchanges">환전 관리</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="chats">고객문의</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="account">계좌 설정</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="content">콘텐츠 관리</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="message">쪽지 관리</button>
        </div>

        <!-- 회원 검색 -->
        <div class="search-box mb-4">
            <input type="text" id="userSearch" placeholder="아이디 또는 이름으로 검색..." 
                   class="w-full bg-gray-800 rounded-lg p-3 text-sm">
        </div>

        <!-- 탭 컨텐츠들 -->

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content active">
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm">이름/아이디</th>
                                <th class="p-3 text-left text-sm">IP 주소</th>
                                <th class="p-3 text-left text-sm">잔액</th>
                                <th class="p-3 text-left text-sm">포인트</th>
                                <th class="p-3 text-left text-sm">가입일</th>
                                <th class="p-3 text-left text-sm">상태</th>
                                <th class="p-3 text-left text-sm">관리</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="divide-y divide-gray-700">
                            <!-- Users will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Approvals Tab -->
        <div id="approvalsTab" class="tab-content">
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm">이름</th>
                                <th class="p-3 text-left text-sm">아이디</th>
                                <th class="p-3 text-left text-sm">가입일</th>
                                <th class="p-3 text-left text-sm">처리</th>
                            </tr>
                        </thead>
                        <tbody id="pendingApprovalTable" class="divide-y divide-gray-700">
                            <!-- Approval requests -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Charges Tab -->
        <div id="chargesTab" class="tab-content">
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm">회원</th>
                                <th class="p-3 text-left text-sm">금액</th>
                                <th class="p-3 text-left text-sm">신청일</th>
                                <th class="p-3 text-left text-sm">포인트옵션</th>
                                <th class="p-3 text-left text-sm">처리</th>
                            </tr>
                        </thead>
                        <tbody id="chargeRequestsBody" class="divide-y divide-gray-700">
                            <!-- Charge requests -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Exchanges Tab -->
        <div id="exchangesTab" class="tab-content">
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm">회원</th>
                                <th class="p-3 text-left text-sm">금액</th>
                                <th class="p-3 text-left text-sm">은행</th>
                                <th class="p-3 text-left text-sm">계좌번호</th>
                                <th class="p-3 text-left text-sm">예금주</th>
                                <th class="p-3 text-left text-sm">처리</th>
                            </tr>
                        </thead>
                        <tbody id="exchangeRequestsBody" class="divide-y divide-gray-700">
                            <!-- Exchange requests -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Chats Tab -->
        <div id="chatsTab" class="tab-content">
            <div class="flex h-96">
                <!-- Chat List -->
                <div class="w-1/3 bg-gray-800 rounded-l-lg overflow-y-auto">
                    <div id="adminChatList" class="p-4 space-y-2">
                        <!-- Chat list -->
                    </div>
                </div>
                
                <!-- Chat Container -->
                <div id="adminChatContainer" class="w-2/3 bg-gray-700 rounded-r-lg hidden">
                    <!-- Chat content -->
                </div>
            </div>
        </div>

        <!-- Account Tab -->
        <div id="accountTab" class="tab-content">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="font-bold mb-4">입금 계좌 설정</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">은행명</label>
                        <input type="text" id="depBank" class="w-full bg-gray-700 rounded p-2" placeholder="은행명">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">계좌번호</label>
                        <input type="text" id="depNumber" class="w-full bg-gray-700 rounded p-2" placeholder="계좌번호">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">예금주</label>
                        <input type="text" id="depHolder" class="w-full bg-gray-700 rounded p-2" placeholder="예금주">
                    </div>
                    <button id="saveDepositAccountBtn" class="w-full bg-orange-500 hover:bg-orange-600 py-3 rounded-lg font-bold">
                        계좌 정보 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Tab (공지/이벤트/쪽지 콘텐츠 관리) -->
    <div id="contentTab" class="tab-content">
        <div class="p-4 bg-gray-900 rounded-md mt-4">
            <h2 class="font-bold mb-2">관리자: 공지사항 / 이벤트 관리</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Form to add -->
                <div class="bg-gray-800/60 p-3 rounded">
                    <h3 class="font-semibold mb-2">새 항목 추가</h3>
                    <label class="block text-xs text-gray-300">타입</label>
                    <select id="new-type" class="w-full p-2 mb-2 bg-gray-700 text-gray-100 rounded">
                        <option value="announcements">공지사항</option>
                        <option value="events">이벤트</option>
                        <option value="messages">쪽지</option>
                    </select>
                    <label class="block text-xs text-gray-300">제목</label>
                    <input id="new-title" class="w-full p-2 mb-2 bg-gray-700 text-gray-100 rounded" placeholder="★추석이벤트★">
                    <label class="block text-xs text-gray-300">순서(order)</label>
                    <input id="new-order" type="number" class="w-full p-2 mb-2 bg-gray-700 text-gray-100 rounded" value="1">
                    <button id="btn-add" class="px-3 py-2 bg-green-600 rounded">추가</button>
                </div>

                <!-- Existing items -->
                <div class="bg-gray-800/60 p-3 rounded">
                    <h3 class="font-semibold mb-2">기존 항목</h3>
                    <div id="items-list" class="space-y-2 max-h-64 overflow-auto"></div>
                </div>
            </div>
        </div>

        <script>
        // 공지/이벤트/쪽지 콘텐츠 관리

        function adminRenderItem(doc, colName) {
          const container = document.createElement('div');
          container.className = 'p-2 bg-gray-700 rounded flex items-center gap-2';

          const titleInput = document.createElement('input');
          titleInput.value = doc.data().title || '';
          titleInput.className = 'flex-1 p-1 bg-gray-800 text-gray-100 rounded';

          const orderInput = document.createElement('input');
          orderInput.type = 'number';
          orderInput.value = doc.data().order || 1;
          orderInput.className = 'w-16 p-1 bg-gray-800 text-gray-100 rounded';

          const activeChk = document.createElement('input');
          activeChk.type = 'checkbox';
          activeChk.checked = doc.data().active !== false;

          const saveBtn = document.createElement('button');
          saveBtn.className = 'px-2 py-1 bg-blue-600 rounded text-sm';
          saveBtn.innerText = '저장';

          const delBtn = document.createElement('button');
          delBtn.className = 'px-2 py-1 bg-red-600 rounded text-sm';
          delBtn.innerText = '삭제';

          container.appendChild(titleInput);
          container.appendChild(orderInput);
          const actLabel = document.createElement('label');
          actLabel.className = 'text-xs flex items-center gap-1';
          actLabel.appendChild(activeChk);
          actLabel.appendChild(document.createTextNode('활성'));
          container.appendChild(actLabel);
          container.appendChild(saveBtn);
          container.appendChild(delBtn);

          // events
          saveBtn.addEventListener('click', async () => {
            try {
              await firebase.firestore().collection(colName).doc(doc.id).update({
                title: titleInput.value,
                order: Number(orderInput.value) || 1,
                active: !!activeChk.checked,
              });
              alert('저장되었습니다.');
            } catch (err) {
              console.error(err);
              alert('저장 실패: ' + err.message);
            }
          });

          delBtn.addEventListener('click', async () => {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            try {
              await firebase.firestore().collection(colName).doc(doc.id).delete();
              alert('삭제되었습니다.');
            } catch (err) {
              console.error(err);
              alert('삭제 실패: ' + err.message);
            }
          });

          return container;
        }

        function loadAdminItems() {
          const list = document.getElementById('items-list');
          list.innerHTML = '';
          const db = firebase.firestore();
          // announcements
          db.collection('announcements').orderBy('order','asc').get().then(snap => {
            snap.forEach(doc => {
              const el = adminRenderItem(doc, 'announcements');
              const wrapper = document.createElement('div');
              const badge = document.createElement('div');
              badge.className = 'text-xs text-yellow-300 mb-1';
              badge.innerText = '공지';
              wrapper.appendChild(badge);
              wrapper.appendChild(el);
              list.appendChild(wrapper);
            });
          });
          // events
          db.collection('events').orderBy('order','asc').get().then(snap => {
            snap.forEach(doc => {
              const el = adminRenderItem(doc, 'events');
              const wrapper = document.createElement('div');
              const badge = document.createElement('div');
              badge.className = 'text-xs text-green-300 mb-1';
              badge.innerText = '이벤트';
              wrapper.appendChild(badge);
              wrapper.appendChild(el);
              list.appendChild(wrapper);
            });
          });
          // messages
          db.collection('messages').orderBy('timestamp','desc').limit(10).get().then(snap => {
            snap.forEach(doc => {
              const el = adminRenderItem(doc, 'messages');
              const wrapper = document.createElement('div');
              const badge = document.createElement('div');
              badge.className = 'text-xs text-blue-300 mb-1';
              badge.innerText = '쪽지';
              wrapper.appendChild(badge);
              wrapper.appendChild(el);
              list.appendChild(wrapper);
            });
          });
        }

        document.addEventListener('DOMContentLoaded', () => {
          document.getElementById('btn-add').addEventListener('click', async () => {
            const type = document.getElementById('new-type').value;
            const title = document.getElementById('new-title').value.trim();
            const order = Number(document.getElementById('new-order').value) || 1;
            if (!title) return alert('제목을 입력하세요.');

            const col = type;    
            const data = {
                title,
                order,
                active: true,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
              await firebase.firestore().collection(col).add(data);
              document.getElementById('new-title').value = '';
              loadAdminItems();
              alert('추가되었습니다.');
            } catch (err) {
              console.error(err);
              alert('추가 실패: ' + err.message);
            }
          });

          // initial load
          loadAdminItems();
        });
        </script>
    </div>

    <!-- Message Management Tab -->
    <div id="messageTab" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Send Message Form -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="font-bold mb-4 text-orange-400">전체 사용자에게 쪽지 보내기</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">쪽지 제목</label>
                        <input type="text" id="messageTitle" class="w-full bg-gray-700 rounded p-2" placeholder="쪽지 제목">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">쪽지 내용</label>
                        <textarea id="messageContent" class="w-full bg-gray-700 rounded p-2" rows="5" placeholder="쪽지 내용"></textarea>
                    </div>
                    <button id="sendMessageBtn" class="w-full bg-orange-500 hover:bg-orange-600 py-3 rounded-lg font-bold">
                        전체 발송
                    </button>
                </div>
            </div>

            <!-- Sent Messages List -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="font-bold mb-4 text-orange-400">보낸 쪽지 목록</h3>
                <div id="sentMessagesList" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Sent messages -->
                </div>
            </div>
        </div>
    </div>

    <!-- User Info Modal -->
    <div id="userInfoModal" class="modal hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">회원 정보</h3>
                <button onclick="closeModal('userInfoModal')" class="text-gray-400 hover:text-white">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="text-center">
                    <img id="infoAvatar" src="" class="w-16 h-16 rounded-full mx-auto mb-2" alt="프로필">
                    <div id="infoStatus" class="status-badge inline-block"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <label class="text-gray-400">이름</label>
                        <div id="infoName" class="font-bold"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">아이디</label>
                        <div id="infoUserId" class="font-bold"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">가입일</label>
                        <div id="infoJoinDate"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">IP 주소</label>
                        <div id="infoIpAddress"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">VPN 상태</label>
                        <div id="infoVpnStatus"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">잔액</label>
                        <div id="infoBalance" class="text-green-400"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">포인트</label>
                        <div id="infoPoint" class="text-yellow-400"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">은행</label>
                        <div id="infoBank"></div>
                    </div>
                    <div>
                        <label class="text-gray-400">계좌번호</label>
                        <div id="infoAccount"></div>
                    </div>
                    <div class="col-span-2">
                        <label class="text-gray-400">예금주</label>
                        <div id="infoAccountName"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="pwChangeModal" class="modal hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">비밀번호 변경</h3>
                <button data-close-pwmodal class="text-gray-400 hover:text-white">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">대상 회원</label>
                    <input type="text" id="pwTargetDisplay" class="w-full bg-gray-700 rounded p-2" readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">새 비밀번호</label>
                    <input type="password" id="pwNew1" class="w-full bg-gray-700 rounded p-2" placeholder="새 비밀번호">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">비밀번호 확인</label>
                    <input type="password" id="pwNew2" class="w-full bg-gray-700 rounded p-2" placeholder="비밀번호 확인">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="pwForceChangeNext" class="mr-2">
                    <label for="pwForceChangeNext" class="text-sm text-gray-400">다음 로그인 시 비밀번호 변경 요구</label>
                </div>
                <button id="pwApplyBtn" class="w-full bg-orange-500 hover:bg-orange-600 py-3 rounded-lg font-bold">
                    비밀번호 변경
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 flex items-center">
            <i data-feather="loader" class="w-8 h-8 text-orange-500 animate-spin mr-3"></i>
            <span>처리 중...</span>
        </div>
    </div>

    <!-- Message View Modal -->
    <div id="messageViewModal" class="modal hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="viewModalTitle" class="font-bold text-lg text-orange-400"></h3>
                <button onclick="closeModal('messageViewModal')" class="text-gray-400 hover:text-white">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div id="viewModalContent" class="text-gray-300 whitespace-pre-wrap max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <script>
const firebaseConfig = {
  apiKey: "AIzaSyCoKaIkh3uGu_YPGfzQDqJTH-LuAZKr970",
  authDomain: "sausage-main.firebaseapp.com",
  projectId: "sausage-main",
  storageBucket: "sausage-main.firebasestorage.app",
  messagingSenderId: "445362758872",
  appId: "1:445362758872:web:e53edc4bdca3e75726e3ad"
};

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const DEFAULT_AVATAR_URL = "https://i.ibb.co/jP4t3sHz/12225935.png";

        // Helper Functions
        function showLoading() {
            document.getElementById("loadingSpinner").classList.remove("hidden");
        }

        function hideLoading() {
            document.getElementById("loadingSpinner").classList.add("hidden");
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove("hidden");
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add("hidden");
        }

        function esc(str = "") {
            return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;")
                              .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
                              .replace(/'/g,"&#39;");
        }

        // Format Functions Error
        function formatFunctionsError(err) {
            try {
                if (!err) return "알 수 없는 오류";
                const code = err.code || err.name || "unknown";
                const msg = err.message || String(err);
                const det = err.details ? "\n세부정보: " + (typeof err.details === "string" ? err.details : JSON.stringify(err.details)) : "";
                return `[${code}] ${msg}${det}`;
            } catch (e) {
                return String(err);
            }
        }

        // Admin Authentication Check
        function checkAdminAccess() {
            const user = auth.currentUser;
            if (!user) {
                window.location.href = "index.html";
                return false;
            }

            db.collection("users").doc(user.uid).get().then((doc) => {
                if (!doc.exists || doc.data().role !== "admin") {
                    alert("관리자 권한이 없습니다.");
                    window.location.href = "index.html";
                } else {
                    document.getElementById("adminName").textContent = doc.data().name + " 관리자";
                }
            });
        }

        // Logout (필요하면 헤더에서 이 함수를 호출해서 사용)
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = "index.html";
            } catch (error) {
                console.error("로그아웃 오류:", error);
            }
        }

        // ===== ADMIN FUNCTIONS =====

        // Load User Data
        async function loadUserData() {
            showLoading();
            try {
                const usersSnapshot = await db.collection("users").get();
                const usersData = [];

                let totalUsers = 0;
                let todayUsers = 0;
                let activeUsers = 0;
                let bannedUsers = 0;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    user.id = doc.id;
                    usersData.push(user);

                    totalUsers++;

                    if (user.joinDate && new Date(user.joinDate) >= today) {
                        todayUsers++;
                    }

                    if (user.status === "active") {
                        activeUsers++;
                    } else if (user.status === "banned") {
                        bannedUsers++;
                    }
                });

                document.getElementById("totalUsers").textContent = totalUsers;
                document.getElementById("todayUsers").textContent = todayUsers;
                document.getElementById("activeUsers").textContent = activeUsers;
                document.getElementById("bannedUsers").textContent = bannedUsers;

                await renderUserTable(usersData);
            } catch (error) {
                console.error("데이터 로드 중 오류:", error);
                alert("데이터를 불러오는 중 오류가 발생했습니다.");
            } finally {
                hideLoading();
            }
        }

        // Render User Table
        async function renderUserTable(users) {
            const tableBody = document.getElementById("userTableBody");
            tableBody.innerHTML = "";

            const searchTerm = document.getElementById("userSearch").value.toLowerCase();
            const filteredUsers = searchTerm ? 
                users.filter((u) => 
                    (u.name && u.name.toLowerCase().includes(searchTerm)) || 
                    (u.userId && u.userId.toLowerCase().includes(searchTerm))
                ) : users;

            if (filteredUsers.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="7" class="p-4 text-center text-gray-400">검색 결과가 없습니다</td>`;
                tableBody.appendChild(row);
                return;
            }

            filteredUsers.forEach((user) => {
                const row = document.createElement("tr");
                if (user.status === "banned") row.style.opacity = "0.6";
                if (user.role === "admin") row.style.backgroundColor = "rgba(0,170,255,.1)";

                row.innerHTML = `
                    <td class="p-3">
                        <div class="font-medium">${esc(user.name) || ""}</div>
                        <div class="text-xs text-gray-400">${esc(user.userId) || ""} ${user.role === "admin" ? "(관리자)" : ""}</div>
                    </td>
                    <td class="p-3 text-sm">${user.ipAddress || ""}</td>
                    <td class="p-3">
                        <input type="number" class="w-20 bg-gray-700 rounded p-1 text-sm" 
                               value="${user.balance || 0}" data-userid="${user.id}" data-type="balance">
                    </td>
                    <td class="p-3">
                        <input type="number" class="w-20 bg-gray-700 rounded p-1 text-sm" 
                               value="${user.point || 0}" data-userid="${user.id}" data-type="point">
                    </td>
                    <td class="p-3 text-sm">${user.joinDate ? new Date(user.joinDate).toLocaleDateString() : ""}</td>
                    <td class="p-3">
                        <select class="bg-gray-700 rounded p-1 text-sm" data-userid="${user.id}">
                            <option value="active" ${user.status === "active" ? "selected" : ""}>활성</option>
                            <option value="banned" ${user.status === "banned" ? "selected" : ""}>정지</option>
                            <option value="pending" ${user.status === "pending" ? "selected" : ""}>대기</option>
                        </select>
                    </td>
                    <td class="p-3">
                        <div class="flex flex-wrap gap-1">
                            <button class="admin-action-btn info" data-uid="${user.id}">정보</button>
                            ${user.role !== "admin" ? `
                                <button class="admin-action-btn" data-action="reset-pw" data-uid="${user.id}" data-userdoc="${user.id}" data-userid="${esc(user.userId)}">비번변경</button>
                                <button class="admin-action-btn block-ip" data-userid="${user.id}" data-ip="${user.ipAddress || ""}">IP차단</button>
                                <button class="admin-action-btn delete" data-userid="${user.id}">삭제</button>
                            ` : "관리자"}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            tableBody.querySelectorAll(".admin-action-btn.info").forEach(btn => {
                btn.addEventListener("click", (e) => viewUserInfoByUid(e.currentTarget.dataset.uid));
            });

            tableBody.querySelectorAll(".admin-action-btn[data-action='reset-pw']").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const target = {
                        uid: btn.dataset.uid,
                        userDocId: btn.dataset.userdoc,
                        loginId: btn.dataset.userid
                    };
                    openPasswordChangeModal(target);
                });
            });

            tableBody.querySelectorAll(".admin-action-btn.delete").forEach(btn => {
                btn.addEventListener("click", () => {
                    if (confirm("정말로 이 사용자를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.")) {
                        deleteUser(btn.dataset.userid);
                    }
                });
            });

            tableBody.querySelectorAll("input[type='number']").forEach(input => {
                input.addEventListener("change", function() {
                    updateUserBalance(this.dataset.userid, this.value, this.dataset.type);
                });
            });

            tableBody.querySelectorAll("select").forEach(sel => {
                sel.addEventListener("change", () => updateUserStatus(sel.dataset.userid, sel.value));
            });
        }

        // Password Change Modal
        function openPasswordChangeModal(target) {
            document.getElementById("pwTargetDisplay").value = target.loginId || target.uid;
            window.PW_CHANGE_TARGET = target;
            openModal("pwChangeModal");
        }

        async function updateUserBalance(userId, value, type = "balance") {
            const numValue = Number(value);
            if (isNaN(numValue) || numValue < 0) {
                alert("유효한 금액을 입력해주세요.");
                return;
            }

            showLoading();
            try {
                await db.collection("users").doc(userId).update({
                    [type]: numValue,
                });
            } catch (error) {
                console.error(`${type} 업데이트 중 오류:`, error);
                alert(`${type} 업데이트에 실패했습니다.`);
            } finally {
                hideLoading();
            }
        }

        async function updateUserStatus(userId, status) {
            showLoading();
            try {
                await db.collection("users").doc(userId).update({ status });
                alert("사용자 상태가 업데이트되었습니다.");
                loadUserData();
            } catch (error) {
                console.error("사용자 상태 업데이트 중 오류:", error);
                alert("사용자 상태 업데이트에 실패했습니다.");
            } finally {
                hideLoading();
            }
        }

        async function deleteUser(userId) {
            showLoading();
            try {
                await db.collection("users").doc(userId).delete();
                alert("사용자가 삭제되었습니다.");
                loadUserData();
            } catch (error) {
                console.error("사용자 삭제 중 오류:", error);
                alert("사용자 삭제에 실패했습니다.");
            } finally {
                hideLoading();
            }
        }

        // View User Info by UID
        async function viewUserInfoByUid(uid) {
            showLoading();
            try {
                const doc = await db.collection("users").doc(uid).get();
                if (!doc.exists) throw new Error("사용자 정보를 찾을 수 없습니다.");
                const u = doc.data();

                let ipAddress = u.ipAddress || "";
                if (!ipAddress) {
                    try {
                        const res = await fetch("https://api.ipify.org?format=json");
                        const data = await res.json();
                        ipAddress = data.ip;
                        await db.collection("users").doc(uid).update({ ipAddress });
                    } catch {
                        ipAddress = "알 수 없음";
                    }
                }
                document.getElementById("infoIpAddress").innerText = ipAddress;

                const vpnEl = document.getElementById("infoVpnStatus");
                if (ipAddress !== "알 수 없음") {
                    try {
                        const isVpn = await isLikelyVpn(ipAddress);
                        vpnEl.innerText = isVpn ? "감지됨 (VPN/프록시 가능성)" : "감지되지 않음";
                        vpnEl.style.color = isVpn ? "#ef4444" : "";
                    } catch {
                        vpnEl.innerText = "확인 불가";
                        vpnEl.style.color = "";
                    }
                } else {
                    vpnEl.innerText = "알 수 없음";
                    vpnEl.style.color = "";
                }

                document.getElementById("infoAvatar").src = u.photoURL || DEFAULT_AVATAR_URL;
                document.getElementById("infoName").innerText = esc(u.name);
                document.getElementById("infoUserId").innerText = esc(u.userId);
                document.getElementById("infoJoinDate").innerText = new Date(u.joinDate).toLocaleString();
                document.getElementById("infoBalance").innerText = (u.balance || 0).toLocaleString() + " 원";
                document.getElementById("infoPoint").innerText = (u.point || 0).toLocaleString() + " P";
                document.getElementById("infoBank").innerText = esc(u.bank);
                document.getElementById("infoAccount").innerText = esc(u.account);
                document.getElementById("infoAccountName").innerText = esc(u.accountName);

                const st = document.getElementById("infoStatus");
                st.textContent = u.status === "active" ? "ACTIVE" : u.status.toUpperCase();
                st.className = "status-badge " + (u.status === "active" ? "status-active" : "status-banned");

                openModal("userInfoModal");
            } catch (err) {
                console.error("회원 정보 조회 오류:", err);
                alert("정보를 불러오는 중 오류가 발생했습니다: " + err.message);
            } finally {
                hideLoading();
            }
        }

        async function isLikelyVpn(ipAddress) {
            try {
                const response = await fetch(`https://ipapi.co/${ipAddress}/json/`);
                const data = await response.json();
                if (data.org && (data.org.toLowerCase().includes("vpn") || data.org.toLowerCase().includes("proxy") || data.org.toLowerCase().includes("hosting"))) {
                    return true;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // Pending approvals
        function loadPendingApprovals() {
            const tbody = document.getElementById("pendingApprovalTable");
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">로드 중…</td></tr>';

            db.collection("approvalRequests")
                .where("status", "==", "pending")
                .orderBy("requestDate", "desc")
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">승인 대기 회원이 없습니다</td></tr>';
                        return;
                    }

                    tbody.innerHTML = "";
                    querySnapshot.forEach((doc) => {
                        const request = doc.data();
                        const row = document.createElement("tr");

                        row.innerHTML = `
                            <td class="p-3">${esc(request.userInfo.name)}</td>
                            <td class="p-3">${esc(request.userInfo.userId)}</td>
                            <td class="p-3">${new Date(request.userInfo.joinDate).toLocaleDateString()}</td>
                            <td class="p-3">
                                <div class="flex gap-1">
                                    <button class="admin-action-btn info" data-uid="${request.userId}">정보</button>
                                    <button class="admin-action-btn approve" data-requestid="${doc.id}" data-userid="${request.userId}">승인</button>
                                    <button class="admin-action-btn reject" data-requestid="${doc.id}" data-userid="${request.userId}">거절</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    tbody.querySelectorAll(".admin-action-btn.info").forEach(btn => {
                        btn.addEventListener("click", (e) => viewUserInfoByUid(e.target.dataset.uid));
                    });

                    tbody.querySelectorAll(".admin-action-btn.approve").forEach(btn => {
                        btn.addEventListener("click", approveUserRegistration);
                    });

                    tbody.querySelectorAll(".admin-action-btn.reject").forEach(btn => {
                        btn.addEventListener("click", rejectUserRegistration);
                    });
                })
                .catch((error) => {
                    console.error("승인 목록 로드 오류:", error);
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">불러오기 실패</td></tr>';
                });
        }

        async function approveUserRegistration(e) {
            const requestId = e.target.dataset.requestid;
            const userId = e.target.dataset.userid;

            if (!confirm("이 사용자의 가입을 승인하시겠습니까?")) return;

            showLoading();
            try {
                await db.collection("approvalRequests").doc(requestId).update({
                    status: "approved",
                    processedDate: new Date().toISOString(),
                    processedBy: auth.currentUser.uid,
                });

                await db.collection("users").doc(userId).update({
                    status: "active",
                    approvedAt: new Date().toISOString(),
                });

                alert("사용자 가입이 승인되었습니다.");
            } catch (error) {
                console.error("가입 승인 오류:", error);
                alert("승인 실패: " + error.message);
            } finally {
                hideLoading();
                loadPendingApprovals();
                loadUserData();
            }
        }

        async function rejectUserRegistration(e) {
            const requestId = e.target.dataset.requestid;
            const userId = e.target.dataset.userid;
            const reason = prompt("거절 사유를 입력해주세요 (사용자 계정이 완전히 삭제됩니다):", "정보 불충분");

            if (!reason) return;

            if (!confirm(`이 사용자의 가입을 완전히 거절하시겠습니까?\n\n사유: ${reason}\n\n※ 주의: 이 작업은 되돌릴 수 없으며 모든 사용자 데이터가 삭제됩니다.`)) {
                return;
            }

            showLoading();
            try {
                await db.runTransaction(async (transaction) => {
                    const requestRef = db.collection("approvalRequests").doc(requestId);
                    transaction.delete(requestRef);

                    const userRef = db.collection("users").doc(userId);
                    transaction.delete(userRef);
                });

                alert("사용자 가입이 완전히 거절되었습니다. 모든 데이터가 삭제되었습니다.");
            } catch (error) {
                console.error("가입 거절 오류:", error);
                alert(`가입 거절 중 오류가 발생했습니다: ${error.message}`);
            } finally {
                hideLoading();
                loadPendingApprovals();
                loadUserData();
            }
        }

        // Charge Requests
        async function loadChargeRequests() {
            const tbody = document.getElementById("chargeRequestsBody");
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">로드 중...</td></tr>';

            try {
                const querySnapshot = await db.collection("chargeRequests")
                    .where("status", "==", "pending")
                    .orderBy("date", "desc")
                    .get();

                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">처리할 충전 신청이 없습니다</td></tr>';
                    return;
                }

                tbody.innerHTML = "";
                const requestsWithUsernames = await Promise.all(
                    querySnapshot.docs.map(async (doc) => {
                        const request = doc.data();
                        const username = await getUsernameFromUid(request.userId);
                        return { id: doc.id, ...request, username };
                    })
                );

                requestsWithUsernames.forEach((request) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="p-3">${request.username}</td>
                        <td class="p-3">${request.amount.toLocaleString()}원</td>
                        <td class="p-3">${new Date(request.date).toLocaleString()}</td>
                        <td class="p-3">${getPointOptionText(request.pointOption)}</td>
                        <td class="p-3">
                            <div class="flex gap-1">
                                <button class="admin-action-btn approve" 
                                    data-requestid="${request.id}" 
                                    data-userid="${request.userId}" 
                                    data-amount="${request.amount}">승인</button>
                                <button class="admin-action-btn reject" 
                                    data-requestid="${request.id}">거절</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                tbody.querySelectorAll(".approve").forEach((btn) => {
                    btn.addEventListener("click", approveChargeRequest);
                });
                tbody.querySelectorAll(".reject").forEach((btn) => {
                    btn.addEventListener("click", rejectChargeRequest);
                });
            } catch (error) {
                console.error("충전 신청 목록 로드 오류:", error);
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-400">데이터를 불러오는 중 오류 발생</td></tr>';
            }
        }

        async function getUsernameFromUid(uid) {
            try {
                const userDoc = await db.collection("users").doc(uid).get();
                if (userDoc.exists) {
                    return userDoc.data().userId || userDoc.data().name || "알 수 없음";
                }
                return "알 수 없음";
            } catch (error) {
                console.error("사용자 정보 가져오기 오류:", error);
                return "알 수 없음";
            }
        }

        function getPointOptionText(optionId) {
            const options = {
                option1: "카지노 롤링 100%",
                option2: "슬롯 첫충 10% 매충 5%",
                option3: "포인트 미지급",
            };
            return options[optionId] || optionId;
        }

        async function approveChargeRequest(e) {
            const requestId = e.target.dataset.requestid;
            const userId = e.target.dataset.userid;
            const amount = parseInt(e.target.dataset.amount);

            if (!confirm(`정말로 이 충전 신청(${amount.toLocaleString()}원)을 승인하시겠습니까?`)) {
                return;
            }

            showLoading();
            try {
                await db.collection("chargeRequests").doc(requestId).update({
                    status: "approved",
                    processedDate: new Date().toISOString(),
                    adminNote: "관리자 승인 완료",
                });

                const userRef = db.collection("users").doc(userId);
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw new Error("사용자를 찾을 수 없습니다");

                    const currentBalance = userDoc.data().balance || 0;
                    transaction.update(userRef, {
                        balance: currentBalance + amount,
                    });
                });

                alert("충전이 승인되었습니다.");
            } catch (error) {
                console.error("충전 승인 오류:", error);
                alert("충전 승인 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
                loadChargeRequests();
            }
        }

        async function rejectChargeRequest(e) {
            const requestId = e.target.dataset.requestid;
            const reason = prompt("거절 사유를 입력해주세요:", "정보 불일치");

            if (!reason) return;

            if (!confirm(`이 충전 신청을 거절하시겠습니까? 사유: ${reason}`)) {
                return;
            }

            showLoading();
            try {
                await db.collection("chargeRequests").doc(requestId).update({
                    status: "rejected",
                    processedDate: new Date().toISOString(),
                    adminNote: reason,
                });

                alert("충전 신청이 거절되었습니다.");
            } catch (error) {
                console.error("충전 거절 오류:", error);
                alert("충전 거절 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
                loadChargeRequests();
            }
        }

        // Exchange Requests
        async function loadExchangeRequests() {
            const tbody = document.getElementById("exchangeRequestsBody");
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">로드 중...</td></tr>';

            try {
                const querySnapshot = await db.collection("exchangeRequests")
                    .where("status", "==", "pending")
                    .orderBy("date", "asc")
                    .get();

                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">처리할 환전 신청이 없습니다</td></tr>';
                    return;
                }

                tbody.innerHTML = "";
                const requestsWithUsernames = await Promise.all(
                    querySnapshot.docs.map(async (doc) => {
                        const request = doc.data();
                        const username = await getUsernameFromUid(request.userId);
                        return { id: doc.id, ...request, username };
                    })
                );

                requestsWithUsernames.forEach((request) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="p-3">${request.username}</td>
                        <td class="p-3">${request.amount.toLocaleString()}원</td>
                        <td class="p-3">${request.bank}</td>
                        <td class="p-3">${request.account}</td>
                        <td class="p-3">${request.accountName}</td>
                        <td class="p-3">
                            <div class="flex gap-1">
                                <button class="admin-action-btn complete" 
                                    data-requestid="${request.id}" 
                                    data-userid="${request.userId}" 
                                    data-amount="${request.amount}">완료</button>
                                <button class="admin-action-btn reject" 
                                    data-requestid="${request.id}">거절</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                tbody.querySelectorAll(".complete").forEach((btn) => {
                    btn.addEventListener("click", completeExchangeRequest);
                });
                tbody.querySelectorAll(".reject").forEach((btn) => {
                    btn.addEventListener("click", rejectExchangeRequest);
                });
            } catch (error) {
                console.error("환전 신청 목록 로드 오류:", error);
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-400">데이터를 불러오는 중 오류 발생</td></tr>';
            }
        }

        async function completeExchangeRequest(e) {
            const requestId = e.target.dataset.requestid;
            const userId = e.target.dataset.userid;
            const amount = parseInt(e.target.dataset.amount);

            if (!confirm(`이 환전 신청(${amount.toLocaleString()}원)을 완료 처리하시겠습니까?`)) {
                return;
            }

            showLoading();
            try {
                await db.collection("exchangeRequests").doc(requestId).update({
                    status: "completed",
                    processedDate: new Date().toISOString(),
                    adminNote: "환전 처리 완료",
                });

                alert("환전이 완료 처리되었습니다.");
            } catch (error) {
                console.error("환전 완료 처리 오류:", error);
                alert("환전 완료 처리 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
                loadExchangeRequests();
            }
        }

        async function rejectExchangeRequest(e) {
            const requestId = e.target.dataset.requestid;
            const reason = prompt("거절 사유를 입력해주세요:", "정보 불일치");

            if (!reason) return;

            if (!confirm(`이 환전 신청을 거절하시겠습니까? 사유: ${reason}`)) {
                return;
            }

            showLoading();
            try {
                const requestDoc = await db.collection("exchangeRequests").doc(requestId).get();
                const requestData = requestDoc.data();

                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection("users").doc(requestData.userId);
                    const userDoc = await transaction.get(userRef);

                    if (userDoc.exists) {
                        const currentBalance = userDoc.data().balance || 0;
                        transaction.update(userRef, {
                            balance: currentBalance + requestData.amount,
                        });
                    }

                    transaction.update(db.collection("exchangeRequests").doc(requestId), {
                        status: "rejected",
                        processedDate: new Date().toISOString(),
                        adminNote: reason,
                    });
                });

                alert("환전 신청이 거절되었습니다.");
            } catch (error) {
                console.error("환전 거절 오류:", error);
                alert("환전 거절 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
                loadExchangeRequests();
            }
        }

        // Chats
        function loadAdminChatList() {
            const chatList = document.getElementById("adminChatList");
            chatList.innerHTML = '<div class="text-center text-gray-400 py-4">채팅 목록 불러오는 중...</div>';

            db.collection("chats")
                .orderBy("updatedAt", "desc")
                .onSnapshot(
                    (querySnapshot) => {
                        if (querySnapshot.empty) {
                            chatList.innerHTML = '<div class="text-center text-gray-400 py-4">활성화된 채팅이 없습니다</div>';
                            return;
                        }

                        chatList.innerHTML = "";
                        querySnapshot.forEach((doc) => {
                            const chat = doc.data();
                            chat.id = doc.id;
                            addChatToList(chat, chatList);
                        });
                    },
                    (error) => {
                        console.error("채팅 목록 구독 오류:", error);
                        chatList.innerHTML = '<div class="text-center text-red-400 py-4">채팅 목록 불러오기 실패</div>';
                    }
                );
        }

        function addChatToList(chat, container) {
            const chatItem = document.createElement("div");
            chatItem.className = `p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 ${window.currentAdminChatId === chat.id ? "bg-gray-600" : ""}`;
            chatItem.dataset.chatId = chat.id;

            const lastMessageTime = new Date(chat.updatedAt).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
            });

            chatItem.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-medium">${chat.userName}</span>
                    <span class="text-xs text-gray-400">${lastMessageTime}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-300 truncate">${chat.lastMessage || "새 채팅"}</span>
                    ${chat.unreadAdmin > 0 ? `<span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-5 text-center">${chat.unreadAdmin}</span>` : ""}
                </div>
            `;

            chatItem.addEventListener("click", () => {
                openAdminChat(chat.id, chat.userName);
            });

            container.appendChild(chatItem);
        }

        function openAdminChat(chatId, userName) {
            window.currentAdminChatId = chatId;

            document.querySelectorAll("#adminChatList > div").forEach((item) => {
                item.classList.toggle("bg-gray-600", item.dataset.chatId === chatId);
            });

            let chatContainer = document.getElementById("adminChatContainer");
            if (!chatContainer) {
                chatContainer = document.createElement("div");
                chatContainer.id = "adminChatContainer";
                chatContainer.className = "admin-chat-container";
                document.querySelector("#chatsTab .flex").appendChild(chatContainer);
            }

            if (!chatContainer.querySelector("#adminChatMessages")) {
                chatContainer.innerHTML = `
                    <div class="admin-chat-header bg-gray-600 p-3 rounded-t-lg flex justify-between items-center">
                        <div class="font-medium">${userName}님과의 채팅</div>
                        <button class="admin-close-chat text-gray-400 hover:text-white">
                            <i data-feather="x"></i>
                        </button>
                    </div>
                    <div class="chat-container h-80 overflow-y-auto p-4 bg-gray-800">
                        <div class="chat-messages" id="adminChatMessages"></div>
                    </div>
                    <div class="chat-input-area p-3 bg-gray-700 rounded-b-lg">
                        <textarea id="adminChatInput" class="w-full bg-gray-600 rounded p-2 text-sm" rows="2" placeholder="메시지를 입력하세요…"></textarea>
                        <button id="adminSendMessageBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded mt-2">전송</button>
                    </div>
                `;
                feather.replace();

                chatContainer.querySelector(".admin-close-chat").addEventListener("click", () => {
                    chatContainer.classList.add("hidden");
                    window.currentAdminChatId = null;
                });

                chatContainer.querySelector("#adminSendMessageBtn").addEventListener("click", sendAdminMessage);
                chatContainer.querySelector("#adminChatInput").addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendAdminMessage();
                    }
                });
            }

            chatContainer.classList.remove("hidden");
            loadAdminChatMessages(chatId);

            db.collection("chats").doc(chatId).update({
                unreadAdmin: 0,
                updatedAt: new Date().toISOString(),
            });
        }

        function loadAdminChatMessages(chatId) {
            const chatMessages = document.getElementById("adminChatMessages");
            if (!chatMessages) return;

            chatMessages.innerHTML = '<div class="text-center text-gray-400 py-4">메시지 불러오는 중...</div>';

            db.collection("chats")
                .doc(chatId)
                .collection("messages")
                .orderBy("timestamp", "asc")
                .onSnapshot(
                    (querySnapshot) => {
                        if (querySnapshot.empty) {
                            chatMessages.innerHTML = '<div class="text-center text-gray-400 py-4">아직 메시지가 없습니다</div>';
                            return;
                        }

                        chatMessages.innerHTML = "";
                        querySnapshot.forEach((doc) => {
                            const message = doc.data();
                            addMessageToAdminChat(message, chatMessages);
                        });

                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    },
                    (error) => {
                        console.error("관리자 채팅 메시지 구독 오류:", error);
                        chatMessages.innerHTML = '<div class="text-center text-red-400 py-4">메시지 불러오기 실패</div>';
                    }
                );
        }

        function addMessageToAdminChat(message, container) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `mb-3 ${message.sender === "admin" ? "text-right" : "text-left"}`;
            
            const bubble = document.createElement("div");
            bubble.className = `inline-block max-w-xs p-3 rounded-lg ${
                message.sender === "admin" 
                    ? "bg-orange-500 text-white rounded-br-none" 
                    : "bg-gray-600 text-white rounded-bl-none"
            }`;
            bubble.textContent = message.text;

            const time = document.createElement("div");
            time.className = "text-xs text-gray-400 mt-1";
            time.textContent = new Date(message.timestamp).toLocaleTimeString([], { 
                hour: "2-digit", minute: "2-digit" 
            });

            messageDiv.appendChild(bubble);
            messageDiv.appendChild(time);
            container.appendChild(messageDiv);
        }

        function sendAdminMessage() {
            const input = document.getElementById("adminChatInput");
            const messageText = input.value.trim();

            if (!messageText || !window.currentAdminChatId) return;

            showLoading();

            const newMessage = {
                text: messageText,
                sender: "admin",
                timestamp: new Date().toISOString(),
                read: false,
            };

            db.collection("chats")
                .doc(window.currentAdminChatId)
                .collection("messages")
                .add(newMessage)
                .then(() => {
                    db.collection("chats")
                        .doc(window.currentAdminChatId)
                        .update({
                            updatedAt: new Date().toISOString(),
                            unreadUser: firebase.firestore.FieldValue.increment(1),
                            lastMessage: messageText.substring(0, 50),
                        });

                    input.value = "";
                })
                .catch((error) => {
                    console.error("관리자 메시지 전송 오류:", error);
                    alert("메시지 전송에 실패했습니다.");
                })
                .finally(() => hideLoading());
        }

        // Deposit Account Management
        function loadDepositAccount() {
            db.collection("config").doc("depositAccount")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const { bank, accountNumber, holder } = doc.data();
                        document.getElementById("depBank").value = bank || "";
                        document.getElementById("depNumber").value = accountNumber || "";
                        document.getElementById("depHolder").value = holder || "";
                    }
                });
        }

        document.getElementById("saveDepositAccountBtn").addEventListener("click", () => {
            const bank = document.getElementById("depBank").value.trim();
            const num = document.getElementById("depNumber").value.trim();
            const holder = document.getElementById("depHolder").value.trim();
            
            if (!bank || !num || !holder) {
                alert("세 항목 모두 입력하세요");
                return;
            }

            showLoading();
            db.collection("config")
                .doc("depositAccount")
                .set({
                    bank,
                    accountNumber: num,
                    holder,
                    updatedAt: new Date().toISOString(),
                })
                .then(() => {
                    alert("입금 계좌가 저장되었습니다. 모든 사용자에게 쪽지를 전송합니다.");
                    
                    const message = {
                        title: "입금 계좌 변경 안내",
                        content: `새로운 입금 계좌는 ${bank} ${num} (${holder}) 입니다.`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false
                    };

                    db.collection("users").get().then(querySnapshot => {
                        const batch = db.batch();
                        querySnapshot.forEach(userDoc => {
                            const userMessagesRef = db.collection("users").doc(userDoc.id).collection("messages").doc();
                            batch.set(userMessagesRef, message);
                        });
                        return batch.commit();
                    }).then(() => {
                        alert("모든 사용자에게 쪽지 전송을 완료했습니다.");
                    }).catch(error => {
                        console.error("쪽지 전송 오류: ", error);
                        alert("사용자에게 쪽지를 전송하는 중 오류가 발생했습니다.");
                    });

                })
                .catch((e) => {
                    console.error("Error saving account:", e);
                    alert("저장 실패: " + e.message);
                })
                .finally(hideLoading);
        });

        // Send custom message to all users and log it
        document.getElementById("sendMessageBtn").addEventListener("click", () => {
            const title = document.getElementById("messageTitle").value.trim();
            const content = document.getElementById("messageContent").value.trim();

            if (!title || !content) {
                alert("제목과 내용을 모두 입력하세요.");
                return;
            }

            if (!confirm("정말로 모든 사용자에게 이 쪽지를 보내시겠습니까?")) {
                return;
            }

            showLoading();

            const message = {
                title,
                content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            };

            db.collection("sentMessages").add(message)
            .then(() => db.collection("users").get())
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    alert("메시지를 보낼 사용자가 없습니다.");
                    hideLoading();
                    return;
                }
                const batch = db.batch();
                querySnapshot.forEach(userDoc => {
                    const userMessagesRef = db.collection("users").doc(userDoc.id).collection("messages").doc();
                    batch.set(userMessagesRef, message);
                });
                return batch.commit().then(() => querySnapshot.size);
            })
            .then(userCount => {
                alert(`모든 사용자 (${userCount}명)에게 쪽지 전송을 완료했습니다.`);
                document.getElementById("messageTitle").value = "";
                document.getElementById("messageContent").value = "";
                loadSentMessages();
            })
            .catch(error => {
                console.error("쪽지 전송 오류: ", error);
                alert("사용자에게 쪽지를 전송하는 중 오류가 발생했습니다.");
            })
            .finally(() => hideLoading());
        });

        function loadSentMessages() {
            const listContainer = document.getElementById("sentMessagesList");
            if (!listContainer) return;

            db.collection("sentMessages")
              .orderBy("timestamp", "desc")
              .limit(20)
              .onSnapshot(snapshot => {
                if (snapshot.empty) {
                    listContainer.innerHTML = `<p class="text-gray-500 text-center">보낸 쪽지가 없습니다.</p>`;
                    return;
                }

                listContainer.innerHTML = "";
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const messageId = doc.id;
                    const formattedDate = message.timestamp
                        ? new Date(message.timestamp.seconds * 1000).toLocaleString("ko-KR")
                        : "N/A";

                    const item = document.createElement("div");
                    item.className = "bg-gray-700 p-3 rounded-lg flex justify-between items-center";
                    item.innerHTML = `
                        <div>
                            <p class="font-bold">${message.title}</p>
                            <p class="text-xs text-gray-400">${formattedDate}</p>
                        </div>
                        <div>
                            <button class="admin-action-btn info view-btn">보기</button>
                            <button class="admin-action-btn reject delete-btn">삭제</button>
                        </div>
                    `;

                    item.querySelector(".view-btn").addEventListener("click", () => {
                        document.getElementById("viewModalTitle").textContent = message.title;
                        document.getElementById("viewModalContent").textContent = message.content;
                        openModal("messageViewModal");
                    });

                    item.querySelector(".delete-btn").addEventListener("click", () => {
                        if (confirm(`'${message.title}' 쪽지를 삭제하시겠습니까? 이 작업은 보낸 쪽지 기록에서만 삭제됩니다.`)) {
                            db.collection("sentMessages").doc(messageId).delete();
                        }
                    });

                    listContainer.appendChild(item);
                });
            });
        }

        // Tabs
        function setupAdminTabs() {
            const tabs = document.querySelectorAll(".admin-tab");
            tabs.forEach((tab) => {
                tab.addEventListener("click", function () {
                    document.querySelectorAll(".admin-tab").forEach((t) => t.classList.remove("active"));
                    document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));

                    this.classList.add("active");
                    const tabId = this.getAttribute("data-tab") + "Tab";
                    document.getElementById(tabId).classList.add("active");

                    const searchBox = document.querySelector(".search-box");
                    if (tabId === "usersTab") {
                        searchBox.style.display = "block";
                    } else {
                        searchBox.style.display = "none";
                    }

                    switch (this.getAttribute("data-tab")) {
                        case "users":
                            loadUserData();
                            break;
                        case "approvals":
                            loadPendingApprovals();
                            break;
                        case "charges":
                            loadChargeRequests();
                            break;
                        case "exchanges":
                            loadExchangeRequests();
                            break;
                        case "chats":
                            loadAdminChatList();
                            break;
                        case "account":
                            loadDepositAccount();
                            break;
                        case "content":
                            loadAdminItems();
                            break;
                        case "message":
                            loadSentMessages();
                            break;
                    }
                });
            });

            document.querySelector(".search-box").style.display = "block";
        }

        function setupSearch() {
            document.getElementById("userSearch").addEventListener("input", debounce(function () {
                loadUserData();
            }, 300));
        }

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        feather.replace();
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkAdminAccess();
                setupAdminTabs();
                setupSearch();
                loadUserData();
            } else {
                window.location.href = "index.html";
            }
        });

        document.querySelectorAll(".modal").forEach((modal) => {
            modal.addEventListener("click", function (e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        document.querySelector("[data-close-pwmodal]").addEventListener("click", () => {
            closeModal("pwChangeModal");
        });

        document.getElementById("pwApplyBtn").addEventListener("click", async () => {
            const newPassword1 = document.getElementById("pwNew1").value;
            const newPassword2 = document.getElementById("pwNew2").value;
            const forceNext = !!document.getElementById("pwForceChangeNext").checked;

            if (newPassword1.length < 6) {
                alert("비밀번호는 6자리 이상이어야 합니다.");
                return;
            }

            if (newPassword1 !== newPassword2) {
                alert("새 비밀번호가 일치하지 않습니다.");
                return;
            }

            if (!window.PW_CHANGE_TARGET || (!window.PW_CHANGE_TARGET.uid && !window.PW_CHANGE_TARGET.userDocId)) {
                alert("오류: 비밀번호를 변경할 대상을 찾을 수 없습니다.");
                return;
            }

            const uid = window.PW_CHANGE_TARGET.userDocId || window.PW_CHANGE_TARGET.uid;
            const displayId = window.PW_CHANGE_TARGET.loginId || uid;

            if (!confirm(`정말로 ${displayId} 회원의 비밀번호를 재설정하시겠습니까?`)) {
                return;
            }

            showLoading();

            try {
                const functions = (firebase.app && firebase.app().functions) ? firebase.app().functions('asia-northeast3') : firebase.functions();
                const adminAction = functions.httpsCallable('adminAction');
                const result = await adminAction({
                    action: 'resetPassword',
                    payload: { uid: uid, newPassword: newPassword1 }
                });

                if (result && result.data && result.data.success) {
                    alert("비밀번호가 성공적으로 변경되었습니다.");
                    closeModal("pwChangeModal");
                    document.getElementById("pwNew1").value = "";
                    document.getElementById("pwNew2").value = "";
                } else {
                    throw new Error(result && result.data && result.data.message ? result.data.message : "함수 처리 실패");
                }
            } catch (fnErr) {
                console.error("Functions 호출 실패:", fnErr);
                alert("비밀번호 변경에 실패했습니다: " + formatFunctionsError(fnErr));
            } finally {
                hideLoading();
            }
        });
    </script>
</body>
</html>
