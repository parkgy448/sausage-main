<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 | SSS CASINO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #0a0a12;
            color: white;
        }
        .admin-tab.active {
            background-color: #f97316;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #374151;
        }
        .admin-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            border: none;
            cursor: pointer;
        }
        .admin-action-btn.info { background-color: #3b82f6; color: white; }
        .admin-action-btn.delete { background-color: #dc2626; color: white; }
        #userTableBody input, #userTableBody select {
             background-color: #374151;
             padding: 4px 6px;
             border-radius: 4px;
             border: 1px solid #4b5563;
             font-size: 12px;
        }
        #accessDenied, #loadingIndicator {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(10, 10, 18, 0.9);
            z-index: 100;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="adminPanel" class="container mx-auto px-4 py-6 hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-orange-400">SSS Casino Admin</h1>
                <div id="adminEmail" class="text-sm text-gray-400"></div>
            </div>
            <a href="index.html" class="text-gray-400 hover:text-white border border-gray-600 rounded-full px-4 py-2 text-sm">메인으로</a>
        </header>

        <!-- 탭 메뉴 -->
        <div class="flex overflow-x-auto border-b border-gray-700 mb-6">
            <button class="admin-tab active px-6 py-3 font-bold whitespace-nowrap" data-tab="users">회원 관리</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap" data-tab="messages">쪽지 관리</button>
            <!-- 다른 탭들은 기능 구현 후 활성화 -->
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap text-gray-500 cursor-not-allowed" disabled>충전 관리</button>
            <button class="admin-tab px-6 py-3 font-bold whitespace-nowrap text-gray-500 cursor-not-allowed" disabled>환전 관리</button>
        </div>

        <!-- 회원 검색 -->
        <div class="search-box mb-4">
            <input type="text" id="userSearch" placeholder="닉네임 또는 이메일로 검색..." 
                   class="w-full bg-gray-800 rounded-lg p-3 text-sm border border-gray-700">
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content active">
            <div class="bg-gray-800/50 rounded-lg overflow-hidden border border-gray-700">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold">닉네임/이메일</th>
                                <th class="p-3 text-left text-sm font-semibold">보유머니</th>
                                <th class="p-3 text-left text-sm font-semibold">포인트</th>
                                <th class="p-3 text-left text-sm font-semibold">가입일</th>
                                <th class="p-3 text-left text-sm font-semibold">역할</th>
                                <th class="p-3 text-left text-sm font-semibold">관리</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="divide-y divide-gray-700">
                            <!-- JS로 채워짐 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messagesTab" class="tab-content">
             <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                <h3 class="font-bold mb-4 text-orange-400">전체 사용자에게 쪽지 보내기</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">쪽지 제목</label>
                        <input type="text" id="messageTitle" class="w-full bg-gray-700 rounded p-2 border border-gray-600" placeholder="쪽지 제목">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">쪽지 내용</label>
                        <textarea id="messageContent" class="w-full bg-gray-700 rounded p-2 border border-gray-600" rows="5" placeholder="쪽지 내용"></textarea>
                    </div>
                    <button id="sendMessageBtn" class="w-full bg-orange-500 hover:bg-orange-600 py-3 rounded-lg font-bold">
                        전체 발송
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="accessDenied">
        <div class="text-center">
            <h2 class="text-2xl font-bold text-red-500">액세스 거부됨</h2>
            <p class="text-gray-400 mt-2">관리자만 이 페이지에 접근할 수 있습니다. 5초 후 메인 페이지로 이동합니다.</p>
        </div>
    </div>

    <div id="loadingIndicator" class="hidden">
         <div class="text-center">
            <h2 class="text-2xl font-bold text-orange-500">데이터 로딩 중...</h2>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./js/firebase-config.js";
        import { listenAuth, fetchCurrentUserProfile } from "./js/auth-utils.js";
        import { collection, getDocs, doc, getDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const adminPanel = document.getElementById('adminPanel');
        const accessDenied = document.getElementById('accessDenied');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const adminEmailEl = document.getElementById('adminEmail');
        const userTableBody = document.getElementById('userTableBody');
        const userSearch = document.getElementById('userSearch');

        let allUsers = []; // 전체 사용자 목록을 캐시

        // 1. 관리자 인증 확인
        listenAuth(async (user) => {
            if (user) {
                const profile = await fetchCurrentUserProfile(user.uid);
                if (profile && profile.role === 'admin') {
                    // 관리자일 경우
                    loadingIndicator.classList.remove('hidden');
                    accessDenied.classList.add('hidden');
                    adminEmailEl.textContent = user.email;
                    await loadAllUsers(); // 모든 사용자 데이터 로드
                    renderUserTable(); // 테이블 렌더링
                    adminPanel.classList.remove('hidden');
                    loadingIndicator.classList.add('hidden');
                } else {
                    // 관리자가 아닐 경우
                    showAccessDenied();
                }
            } else {
                // 로그인하지 않았을 경우
                showAccessDenied();
            }
        });

        function showAccessDenied() {
            adminPanel.classList.add('hidden');
            accessDenied.classList.remove('hidden');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 5000);
        }
        
        // 2. 모든 사용자 데이터 로드
        async function loadAllUsers() {
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error loading users:", error);
                alert('사용자 목록을 불러오는 데 실패했습니다.');
            }
        }
        
        // 3. 사용자 테이블 렌더링
        function renderUserTable() {
            userTableBody.innerHTML = ""; // 테이블 비우기
            
            const searchTerm = userSearch.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => {
                const nickname = user.nickname?.toLowerCase() || '';
                const email = user.email?.toLowerCase() || '';
                return nickname.includes(searchTerm) || email.includes(searchTerm);
            });

            if (filteredUsers.length === 0) {
                userTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">표시할 사용자가 없습니다.</td></tr>`;
                return;
            }

            filteredUsers.forEach(user => {
                const tr = document.createElement('tr');
                const joinDate = user.createdAt?.toDate()?.toLocaleDateString() || '알 수 없음';

                tr.innerHTML = `
                    <td class="p-3">
                        <div class="font-medium">${user.nickname || 'N/A'}</div>
                        <div class="text-xs text-gray-400">${user.email}</div>
                    </td>
                    <td class="p-3">
                        <input type="number" value="${user.money || 0}" data-id="${user.id}" data-field="money" class="w-24"> 원
                    </td>
                    <td class="p-3">
                        <input type="number" value="${user.point || 0}" data-id="${user.id}" data-field="point" class="w-24"> P
                    </td>
                    <td class="p-3 text-sm">${joinDate}</td>
                    <td class="p-3">
                        <select data-id="${user.id}" data-field="role" class="w-24">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                    <td class="p-3">
                        <button class="admin-action-btn delete" data-id="${user.id}" data-nickname="${user.nickname}">삭제</button>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });
        }
        
        // 4. 이벤트 리스너 바인딩
        userSearch.addEventListener('input', () => renderUserTable());

        userTableBody.addEventListener('change', async (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            const field = target.dataset.field;
            let value = target.value;

            if (target.type === 'number') {
                value = Number(value);
                if (isNaN(value) || value < 0) {
                    alert('유효한 숫자를 입력하세요.');
                    // 원래 값으로 되돌리는 로직 추가 가능
                    return;
                }
            }
            
            try {
                loadingIndicator.classList.remove('hidden');
                const userDocRef = doc(db, "users", id);
                await updateDoc(userDocRef, { [field]: value });
                // 로컬 캐시 업데이트
                const userInCache = allUsers.find(u => u.id === id);
                if(userInCache) userInCache[field] = value;
            } catch (error) {
                console.error(`Error updating user ${field}:`, error);
                alert('업데이트에 실패했습니다.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });
        
        userTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete')) {
                const id = e.target.dataset.id;
                const nickname = e.target.dataset.nickname;
                if (confirm(`정말로 '${nickname}' 사용자를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                     try {
                        loadingIndicator.classList.remove('hidden');
                        await deleteDoc(doc(db, "users", id));
                        allUsers = allUsers.filter(u => u.id !== id);
                        renderUserTable();
                        alert('사용자가 삭제되었습니다.');
                    } catch (error) {
                        console.error("Error deleting user:", error);
                        alert('사용자 삭제에 실패했습니다.');
                    } finally {
                        loadingIndicator.classList.add('hidden');
                    }
                }
            }
        });

        // 탭 기능
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if(this.disabled) return;
                
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                this.classList.add('active');
                const tabName = this.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // 쪽지 발송 기능
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        sendMessageBtn.addEventListener('click', async () => {
            const title = document.getElementById('messageTitle').value;
            const content = document.getElementById('messageContent').value;

            if (!title.trim() || !content.trim()) {
                alert('제목과 내용을 모두 입력해주세요.');
                return;
            }

            if (!confirm('정말로 모든 사용자에게 이 쪽지를 발송하시겠습니까?')) {
                return;
            }

            loadingIndicator.classList.remove('hidden');
            try {
                // 1. 모든 사용자 문서를 가져옵니다.
                const usersSnapshot = await getDocs(query(collection(db, "users")));
                if (usersSnapshot.empty) {
                    alert("쪽지를 보낼 사용자가 없습니다.");
                    return;
                }

                // 2. Batch 쓰기를 준비합니다.
                const batch = writeBatch(db);
                const messageData = {
                    title: title,
                    content: content,
                    read: false,
                    timestamp: serverTimestamp()
                };

                usersSnapshot.forEach(userDoc => {
                    // 각 사용자의 messages 서브컬렉션에 새 쪽지 문서를 추가합니다.
                    const messageRef = doc(collection(db, "userMessages", userDoc.id, "messages"));
                    batch.set(messageRef, messageData);
                });

                // 3. Batch 쓰기를 실행합니다.
                await batch.commit();

                alert(`${usersSnapshot.size}명의 모든 사용자에게 쪽지를 성공적으로 발송했습니다.`);
                document.getElementById('messageTitle').value = '';
                document.getElementById('messageContent').value = '';

            } catch (error) {
                console.error("전체 쪽지 발송 오류: ", error);
                alert(`쪽지 발송 중 오류가 발생했습니다: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
